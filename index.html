<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Studio Ultra</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --border: #27272a;
            --accent: #6366f1;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
            --folder-color: #fbbf24;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 5px; border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Layout Components */
        .glass-panel {
            background: rgba(24, 24, 27, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Project Cards */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 2rem 0;
        }

        .project-card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .project-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.3);
        }

        .card-preview {
            height: 160px;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
        }
        
        .card-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .project-card:hover .card-preview img { opacity: 1; }

        /* Editor Layout */
        #ide-container { display: flex; flex: 1; overflow: hidden; height: 100%; }
        
        .sidebar { width: 300px; background: #101012; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        
        .editor-area { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #0c0c0e; position: relative; }
        
        .preview-area { 
            width: 0%; 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid var(--border);
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden; 
        }

        /* File Tree Styles */
        .file-tree-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            user-select: none;
            font-size: 13px;
            color: var(--text-dim);
            border-left: 2px solid transparent;
            position: relative;
        }
        .file-tree-item:hover { background: #18181b; color: var(--text-main); }
        .file-tree-item.active { background: #18181b; color: #fff; border-left-color: var(--accent); }
        
        /* Action buttons in tree */
        .tree-actions {
            display: none;
            margin-left: auto;
            gap: 4px;
        }
        .file-tree-item:hover .tree-actions { display: flex; }
        .action-btn {
            padding: 2px;
            border-radius: 3px;
            color: #71717a;
        }
        .action-btn:hover { color: #fff; background: #27272a; }
        .action-btn.delete:hover { color: #ef4444; }

        /* Code Editor & Asset Viewer */
        .editor-wrapper { 
            position: relative; 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
        }
        
        .gutter {
            width: 48px;
            background: #101012;
            color: #52525b;
            text-align: right;
            padding: 20px 8px 0 0;
            font-size: 13px;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid var(--border);
            overflow: hidden;
        }

        #editing-layer, #highlighting-layer {
            position: absolute; top: 0; left: 0;
            margin: 0; padding: 20px;
            width: 100%; height: 100%;
            font-size: 13px; line-height: 1.5;
            white-space: pre; word-wrap: normal;
            border: none; outline: none;
        }

        #editing-layer {
            z-index: 2; 
            color: transparent; 
            background: transparent;
            caret-color: var(--accent); 
            resize: none;
            overflow: auto; 
        }

        #highlighting-layer { 
            z-index: 1; 
            pointer-events: none; 
            overflow: hidden; 
        }

        #asset-viewer {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #121215;
            color: #71717a;
            padding: 2rem;
            text-align: center;
        }

        .asset-preview-image {
            max-width: 80%;
            max-height: 60%;
            object-fit: contain;
            border: 1px solid #3f3f46;
            background: url('data:image/svg+xml;utf8,<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><rect width="10" height="10" fill="%2318181b"/><rect x="10" y="10" width="10" height="10" fill="%2318181b"/><rect x="0" y="10" width="10" height="10" fill="%2327272a"/><rect x="10" y="0" width="10" height="10" fill="%2327272a"/></svg>');
        }

        #scroll-top-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s;
            cursor: pointer;
            pointer-events: none;
        }

        #scroll-top-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Console */
        .console-panel {
            height: 150px;
            background: #09090b;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .console-logs {
            flex: 1;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 8px;
        }

        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-info { color: #a1a1aa; }
        .log-error { color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .log-warn { color: #facc15; }

        /* Resizer */
        #resizer {
            width: 4px;
            background: transparent;
            cursor: col-resize;
            z-index: 50;
            margin-left: -2px;
            transition: background 0.2s;
        }
        #resizer:hover { background: var(--accent); }

        /* Editable Project Name */
        #project-name-input {
            background: transparent;
            border: 1px solid transparent;
            color: white;
            font-size: 1.125rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            width: 200px;
            transition: all 0.2s;
        }
        #project-name-input:hover { border-color: #3f3f46; }
        #project-name-input:focus { 
            border-color: var(--accent); 
            outline: none; 
            background: #18181b;
        }

        /* Stats Bar */
        #stats-bar {
            height: 24px;
            background: #09090b;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 10px;
            color: #52525b;
            gap: 12px;
        }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="h-14 glass-panel flex items-center justify-between px-6 z-40 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="showHome()">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-lg group-hover:scale-105 transition-transform">
                    N
                </div>
            </div>
            <!-- Dynamic Project Name / Home Title -->
            <div id="header-title-area" class="hidden flex items-center gap-2">
                <span class="text-zinc-600">/</span>
                <input type="text" id="project-name-input" value="Untitled Project" onchange="updateProjectName(this.value)">
            </div>
            <div id="home-title-area">
                <span class="font-semibold text-lg tracking-tight">Nebula<span class="font-light text-indigo-400">Studio</span></span>
            </div>
        </div>

        <div id="toolbar" class="hidden flex items-center gap-3">
            <button onclick="shareProject()" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded-md text-xs font-bold transition-colors shadow-lg shadow-emerald-900/20" title="Get Shareable Link">
                <i data-lucide="share-2" width="14" height="14"></i> SHARE
            </button>
            <div class="h-6 w-px bg-white/10 mx-2"></div>
            <button onclick="runProject()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-md text-xs font-bold transition-colors shadow-lg shadow-indigo-500/20">
                <i data-lucide="play" width="14" height="14"></i> RUN
            </button>
            <button onclick="exportProject()" class="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-4 py-1.5 rounded-md text-xs font-bold transition-colors border border-zinc-700">
                <i data-lucide="download" width="14" height="14"></i> EXPORT
            </button>
            <button onclick="togglePreview(true)" class="p-2 text-zinc-400 hover:text-white rounded-md hover:bg-zinc-800 transition-colors" title="Full Screen">
                <i data-lucide="maximize" width="14" height="14"></i>
            </button>
        </div>
    </header>

    <!-- 1. Home Screen (Gallery) -->
    <main id="view-home" class="flex-1 overflow-y-auto bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-zinc-800 via-zinc-950 to-black">
        <div class="max-w-7xl mx-auto p-8">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">Projects</h1>
                    <p class="text-zinc-400">Manage your experiments and applications.</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="resetEngine()" class="border border-red-900/50 text-red-500 hover:bg-red-900/20 px-4 py-3 rounded-lg font-bold transition-colors text-sm flex items-center gap-2">
                         <i data-lucide="refresh-ccw" width="16" height="16"></i> FACTORY RESET
                    </button>
                    <button onclick="createNewProject()" class="bg-white text-black hover:bg-zinc-200 px-6 py-3 rounded-full font-bold transition-all transform active:scale-95 shadow-xl flex items-center gap-2">
                        <i data-lucide="plus" width="18" height="18"></i> New Project
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="relative mb-8">
                <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-zinc-500" width="18" height="18"></i>
                <input type="text" id="project-search" placeholder="Search projects..." 
                       class="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl pl-12 pr-4 py-4 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all" 
                       oninput="renderProjectGrid()">
            </div>

            <div id="project-list" class="project-grid">
                <!-- Cards Injected Here -->
            </div>
        </div>
    </main>

    <!-- 2. IDE View -->
    <main id="view-ide" class="hidden flex-1 relative min-h-0 flex flex-col">
        <div id="ide-container" class="flex-1 overflow-hidden flex">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="p-4 border-b border-[#27272a] flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-zinc-500 uppercase tracking-wider">Explorer</span>
                    <div class="flex gap-1">
                         <button onclick="triggerNewFolder()" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white transition-colors" title="New Folder">
                            <i data-lucide="folder-plus" width="14" height="14"></i>
                        </button>
                        <button onclick="triggerUpload()" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white transition-colors" title="Upload Files">
                            <i data-lucide="upload" width="14" height="14"></i>
                        </button>
                        <button onclick="addNewFile()" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white transition-colors" title="New File">
                            <i data-lucide="file-plus" width="14" height="14"></i>
                        </button>
                    </div>
                </div>
                <!-- Extended Input Support -->
                <input type="file" id="fileInput" multiple accept=".html,.css,.js,.txt,.json,.xml,.md,.png,.jpg,.jpeg,.gif,.svg,.mp3,.wav,.ogg,.glb,.gltf,.obj" class="hidden">
                <div id="file-list" class="flex-1 overflow-y-auto py-2"></div>
                
                <!-- Project Size Indicator -->
                <div class="p-3 border-t border-[#27272a] bg-[#0c0c0e] text-[11px] text-zinc-500 flex flex-col gap-1">
                    <div class="flex justify-between items-center">
                        <span>Size (MB):</span>
                        <span id="project-size-mb" class="font-mono text-zinc-300">0.00 MB</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Size (Mb):</span>
                        <span id="project-size-bit" class="font-mono text-zinc-400">0.00 Mb</span>
                    </div>
                </div>
            </aside>

            <!-- Editor / Viewer -->
            <section class="editor-area">
                <!-- File Tabs / Header -->
                <div class="h-10 bg-[#141417] border-b border-[#27272a] flex items-center justify-between px-4 shrink-0">
                    <div class="flex items-center gap-2 text-xs">
                        <span class="text-zinc-500">Editing:</span>
                        <span id="active-filename" class="text-indigo-400 font-mono font-bold">index.html</span>
                    </div>
                    <select id="file-strategy" class="bg-[#18181b] border border-[#27272a] text-[10px] rounded px-2 py-1 text-zinc-400 focus:border-indigo-500 outline-none">
                        <option value="classic">Classic Script</option>
                        <option value="module">ES Module</option>
                    </select>
                </div>

                <div class="editor-wrapper">
                    <!-- Text Editor Components -->
                    <div id="gutter" class="gutter font-mono"></div>
                    <div id="editor-container" class="relative flex-1">
                        <textarea id="editing-layer" class="font-mono" spellcheck="false"></textarea>
                        <pre id="highlighting-layer" class="font-mono"><code id="code-content"></code></pre>
                        
                        <!-- Scroll Top Button -->
                        <div id="scroll-top-btn" onclick="scrollToTop()">
                            <i data-lucide="arrow-up" width="16" height="16"></i>
                        </div>
                    </div>

                    <!-- Asset Viewer Component -->
                    <div id="asset-viewer">
                        <div id="asset-preview-container" class="flex flex-col items-center gap-4">
                            <!-- Injected by JS -->
                        </div>
                        <p class="mt-6 text-sm text-zinc-500 max-w-xs">
                            <span class="font-bold text-zinc-400">Path:</span> 
                            <code id="asset-usage-code" class="bg-black px-1 py-0.5 rounded text-indigo-400 select-all"></code>
                        </p>
                    </div>
                </div>

                <!-- Console -->
                <div class="console-panel shrink-0">
                    <div class="h-8 bg-[#141417] border-b border-[#27272a] flex items-center justify-between px-4">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Terminal / Console</span>
                        <button onclick="clearConsole()" class="text-[10px] text-zinc-500 hover:text-white">CLEAR</button>
                    </div>
                    <div id="console-logs" class="console-logs"></div>
                </div>
            </section>

            <!-- Resizer Handle -->
            <div id="resizer"></div>

            <!-- Preview -->
            <section id="preview-panel" class="preview-area">
                <div class="h-10 bg-zinc-100 border-b border-zinc-300 flex items-center justify-between px-4 shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs font-bold text-zinc-600">Live Server</span>
                    </div>
                    <button onclick="closePreview()" class="text-zinc-400 hover:text-red-500">
                        <i data-lucide="x" width="14" height="14"></i>
                    </button>
                </div>
                <!-- Wrapper for capturing -->
                <div id="preview-wrapper" class="w-full h-full relative overflow-hidden">
                    <iframe id="preview-frame" class="w-full h-full border-none block"></iframe>
                </div>
            </section>
        </div>
        <!-- Status Bar -->
        <div id="stats-bar">
            <span>Nebula Engine v2.2</span>
            <span class="flex-1"></span>
            <span id="status-msg">Ready</span>
        </div>
    </main>

    <!-- Logic -->
    <script>
        // --- CONSTANTS ---
        const DEFAULT_PROJECT = {
            id: null,
            name: "Welcome Project",
            thumbnail: null,
            lastModified: Date.now(),
            files: [
                {
                    name: "index.html",
                    type: "file",
                    isBinary: false,
                    content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nebula Welcome</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>Welcome to Nebula</h1>
        <p>A virtual IDE for the web.</p>
        <div id="output">Initializing...</div>
    </div>
    <script type="module" src="js/app.js"><\/script>
</body>
</html>`
                },
                { name: "css", type: "folder" },
                {
                    name: "css/style.css",
                    type: "file",
                    isBinary: false,
                    content: `body {
    background: #0f172a;
    color: white;
    font-family: system-ui, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
.container {
    text-align: center;
    background: #1e293b;
    padding: 3rem;
    border-radius: 1rem;
    border: 1px solid #334155;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
}
h1 { color: #818cf8; margin-bottom: 0.5rem; }
#output { 
    margin-top: 2rem; 
    font-family: monospace; 
    color: #4ade80; 
}`
                },
                { name: "js", type: "folder" },
                {
                    name: "js/utils.js",
                    type: "file",
                    isBinary: false,
                    strategy: "module",
                    content: `export function greet() {
    return "System Online. Ready for coding.";
}`
                },
                {
                    name: "js/app.js",
                    type: "file",
                    isBinary: false,
                    strategy: "module",
                    content: `import { greet } from "./utils.js";
const el = document.getElementById("output");
el.innerText = greet();`
                }
            ]
        };

        // --- STATE MANAGEMENT ---
        let projects = JSON.parse(localStorage.getItem('nebula_ultra_projects')) || [];
        if(projects.length === 0) {
            // Ensure at least default exists on fresh load
            const welcome = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
            welcome.id = 'proj-welcome';
            projects.push(welcome);
            localStorage.setItem('nebula_ultra_projects', JSON.stringify(projects));
        }

        let expandedFolders = new Set(['css', 'js']); // Default expanded
        
        // --- DOM ELEMENTS ---
        const dom = {
            home: document.getElementById('view-home'),
            ide: document.getElementById('view-ide'),
            projectList: document.getElementById('project-list'),
            fileList: document.getElementById('file-list'),
            editor: document.getElementById('editing-layer'),
            highlighter: document.getElementById('highlighting-layer'),
            codeContent: document.getElementById('code-content'),
            gutter: document.getElementById('gutter'),
            editorContainer: document.getElementById('editor-container'),
            assetViewer: document.getElementById('asset-viewer'),
            assetPreview: document.getElementById('asset-preview-container'),
            assetUsage: document.getElementById('asset-usage-code'),
            previewPanel: document.getElementById('preview-panel'),
            previewFrame: document.getElementById('preview-frame'),
            console: document.getElementById('console-logs'),
            filename: document.getElementById('active-filename'),
            strategy: document.getElementById('file-strategy'),
            toolbar: document.getElementById('toolbar'),
            resizer: document.getElementById('resizer'),
            fileInput: document.getElementById('fileInput'),
            projectNameInput: document.getElementById('project-name-input'),
            headerTitleArea: document.getElementById('header-title-area'),
            homeTitleArea: document.getElementById('home-title-area'),
            scrollTopBtn: document.getElementById('scroll-top-btn'),
            projectSizeMB: document.getElementById('project-size-mb'),
            projectSizeBit: document.getElementById('project-size-bit'),
            statusMsg: document.getElementById('status-msg'),
            projectSearch: document.getElementById('project-search')
        };

        let currentProject = null;
        let activeFileName = "index.html"; 

        // --- HELPER: FILE TYPES & PATHS ---
        function getFileType(name) {
            const ext = name.split('.').pop().toLowerCase();
            if(['png','jpg','jpeg','gif','svg','webp'].includes(ext)) return 'image';
            if(['mp3','wav','ogg'].includes(ext)) return 'audio';
            if(['glb','gltf','obj','stl'].includes(ext)) return 'model';
            return 'text';
        }

        function resolvePath(basePath, relativePath) {
            const stack = basePath.includes('/') ? basePath.split('/').slice(0, -1) : [];
            const parts = relativePath.split('/');
            for (let part of parts) {
                if (part === '.' || part === '') continue;
                if (part === '..') {
                    if (stack.length > 0) stack.pop();
                } else {
                    stack.push(part);
                }
            }
            return stack.join('/');
        }

        // --- CALC SIZE ---
        function updateProjectStats() {
            if(!currentProject) return;
            let totalBytes = 0;
            currentProject.files.forEach(f => {
                if(f.type === 'folder') return;
                if(f.isBinary) {
                    const base64Len = f.content.indexOf(',') > -1 ? f.content.split(',')[1].length : 0;
                    totalBytes += (base64Len * 3) / 4; 
                } else {
                    totalBytes += new Blob([f.content]).size;
                }
            });
            const mb = (totalBytes / (1024 * 1024)).toFixed(2);
            const bits = ((totalBytes * 8) / (1024 * 1024)).toFixed(2);
            dom.projectSizeMB.innerText = `${mb} MB`;
            dom.projectSizeBit.innerText = `${bits} Mb`;
        }

        // --- NAVIGATION ---
        function showHome() {
            dom.ide.classList.add('hidden');
            dom.home.classList.remove('hidden');
            dom.toolbar.classList.add('hidden');
            dom.headerTitleArea.classList.add('hidden');
            dom.homeTitleArea.classList.remove('hidden');
            renderProjectGrid();
        }

        function openProject(id, loadedProject = null) {
            currentProject = loadedProject || projects.find(p => p.id === id);
            if(!currentProject) return;

            // Migration
            currentProject.files.forEach(f => {
                if(!f.type) f.type = 'file';
            });

            currentProject.lastModified = Date.now();
            saveData();
            
            dom.home.classList.add('hidden');
            dom.ide.classList.remove('hidden');
            dom.toolbar.classList.remove('hidden');
            dom.homeTitleArea.classList.add('hidden');
            dom.headerTitleArea.classList.remove('hidden');
            dom.projectNameInput.value = currentProject.name;
            
            const index = currentProject.files.find(f => f.name === 'index.html');
            activeFileName = index ? index.name : currentProject.files[0].name;
            
            renderFileList();
            loadEditor();
            updateProjectStats();
            lucide.createIcons();
        }

        function createNewProject() {
            const name = prompt("Enter Project Name:", "My App");
            if (!name || name.trim() === "") return;

            const newP = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
            newP.id = 'proj-' + Date.now();
            newP.name = name;
            
            // Clean out the default content if user wants empty, but let's keep it structured for now
            // Just unique-ify files if needed, but since it's a new project object, it's fine.
            
            projects.unshift(newP);
            saveData();
            openProject(newP.id);
        }

        function resetEngine() {
            if(confirm("âš  WARNING: FACTORY RESET âš \n\nThis will delete ALL projects and return Nebula Studio to its initial state.\n\nAre you sure you want to continue?")) {
                if(confirm("FINAL CONFIRMATION\n\nAll data will be permanently lost. This cannot be undone.")) {
                    localStorage.removeItem('nebula_ultra_projects');
                    location.reload();
                }
            }
        }

        // --- RENDERERS ---
        function renderProjectGrid() {
            dom.projectList.innerHTML = '';
            const term = dom.projectSearch.value.toLowerCase();
            
            const filtered = projects.filter(p => p.name.toLowerCase().includes(term));
            
            if(filtered.length === 0) {
                dom.projectList.innerHTML = `<div class="col-span-full text-center text-zinc-500 py-12">No projects found.</div>`;
                return;
            }

            filtered.sort((a,b) => b.lastModified - a.lastModified).forEach(p => {
                const el = document.createElement('div');
                el.className = 'project-card group';
                
                const thumbnailHtml = p.thumbnail 
                    ? `<img src="${p.thumbnail}" alt="Preview">` 
                    : `<div class="text-6xl opacity-20 animate-pulse text-indigo-500 font-mono">&lt;/&gt;</div>`;

                el.onclick = () => openProject(p.id);
                el.innerHTML = `
                    <div class="card-preview">
                        ${thumbnailHtml}
                    </div>
                    <div class="p-4 flex-1 flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-white group-hover:text-indigo-400 transition-colors truncate" title="${p.name}">${p.name}</h3>
                            <p class="text-xs text-zinc-500 mt-1">${p.files.filter(f=>f.type==='file').length} Files â€¢ ${new Date(p.lastModified).toLocaleDateString()}</p>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button onclick="deleteProject(event, '${p.id}')" class="text-zinc-600 hover:text-red-500 text-xs px-2 py-1 rounded hover:bg-zinc-800 transition-colors">DELETE</button>
                        </div>
                    </div>
                `;
                dom.projectList.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- TREE VIEW RENDERER ---
        function renderFileList() {
            dom.fileList.innerHTML = '';
            
            const tree = { name: "root", children: {}, files: [] };
            
            currentProject.files.forEach(file => {
                const parts = file.name.split('/');
                let current = tree;
                for(let i=0; i < parts.length - 1; i++) {
                    const part = parts[i];
                    if(!current.children[part]) {
                        current.children[part] = { name: part, path: parts.slice(0,i+1).join('/'), children: {}, files: [] };
                    }
                    current = current.children[part];
                }
                const fileName = parts[parts.length - 1];
                if(file.type === 'folder') {
                   if(!current.children[fileName]) {
                       current.children[fileName] = { name: fileName, path: file.name, children: {}, files: [] };
                   }
                } else {
                    current.files.push({ ...file, shortName: fileName });
                }
            });

            function renderNode(node, depth = 0) {
                const container = document.createElement('div');
                const folders = Object.values(node.children).sort((a,b) => a.name.localeCompare(b.name));
                const files = node.files.sort((a,b) => a.shortName.localeCompare(b.shortName));

                folders.forEach(folder => {
                    const isExpanded = expandedFolders.has(folder.path);
                    const folderEl = document.createElement('div');
                    folderEl.className = 'file-tree-item';
                    folderEl.style.paddingLeft = (depth * 12 + 8) + 'px';
                    folderEl.innerHTML = `
                        <div class="flex items-center flex-1 overflow-hidden">
                            <i data-lucide="${isExpanded ? 'folder-open' : 'folder'}" width="14" height="14" class="mr-2 text-amber-400 shrink-0"></i>
                            <span class="truncate">${folder.name}</span>
                        </div>
                        <div class="tree-actions">
                             <button onclick="triggerRename(event, '${folder.path}')" class="action-btn" title="Rename"><i data-lucide="pencil" width="12" height="12"></i></button>
                        </div>
                    `;
                    folderEl.onclick = (e) => {
                        e.stopPropagation();
                        if(isExpanded) expandedFolders.delete(folder.path);
                        else expandedFolders.add(folder.path);
                        renderFileList();
                    };
                    container.appendChild(folderEl);
                    if(isExpanded) container.appendChild(renderNode(folder, depth + 1));
                });

                files.forEach(file => {
                    const type = getFileType(file.name);
                    let icon = 'file';
                    let color = 'text-zinc-500';
                    
                    if(file.name.endsWith('.html')) { icon='file-code'; color='text-orange-500'; }
                    else if(file.name.endsWith('.css')) { icon='palette'; color='text-blue-400'; }
                    else if(file.name.endsWith('.js')) { icon='file-code-2'; color='text-yellow-400'; }
                    else if(type === 'image') { icon='image'; color='text-pink-400'; }
                    else if(type === 'audio') { icon='music'; color='text-green-400'; }
                    else if(type === 'model') { icon='box'; color='text-orange-400'; }

                    const fileEl = document.createElement('div');
                    fileEl.className = `file-tree-item ${file.name === activeFileName ? 'active' : ''} group`;
                    fileEl.style.paddingLeft = (depth * 12 + 8) + 'px';
                    fileEl.innerHTML = `
                        <div class="flex items-center flex-1 overflow-hidden">
                            <i data-lucide="${icon}" width="14" height="14" class="mr-2 ${color} shrink-0"></i>
                            <span class="truncate">${file.shortName}</span>
                        </div>
                        <div class="tree-actions">
                            <button onclick="triggerRename(event, '${file.name}')" class="action-btn" title="Rename"><i data-lucide="pencil" width="12" height="12"></i></button>
                            <button onclick="deleteFile(event, '${file.name}')" class="action-btn delete" title="Delete"><i data-lucide="trash-2" width="12" height="12"></i></button>
                        </div>
                    `;
                    fileEl.onclick = () => {
                        activeFileName = file.name;
                        renderFileList();
                        loadEditor();
                    };
                    container.appendChild(fileEl);
                });
                return container;
            }
            dom.fileList.appendChild(renderNode(tree));
            lucide.createIcons();
        }

        // --- EDITOR & VIEWER LOGIC ---
        function loadEditor() {
            const file = currentProject.files.find(f => f.name === activeFileName);
            if(!file) return;

            dom.filename.innerText = file.name;
            
            if(file.isBinary) {
                dom.editorContainer.classList.add('hidden');
                dom.gutter.classList.add('hidden');
                dom.assetViewer.style.display = 'flex';
                dom.strategy.style.display = 'none';
                renderAssetPreview(file);
            } else {
                dom.editorContainer.classList.remove('hidden');
                dom.gutter.classList.remove('hidden');
                dom.assetViewer.style.display = 'none';
                dom.strategy.style.display = file.name.endsWith('.js') ? 'block' : 'none';
                dom.strategy.value = file.strategy || 'classic';
                
                dom.editor.value = file.content;
                dom.editor.scrollTop = 0;
                updateHighlight();
            }
        }

        function renderAssetPreview(file) {
            const type = getFileType(file.name);
            dom.assetPreview.innerHTML = '';
            dom.assetUsage.innerText = `./${file.name}`;
            
            if(type === 'image') {
                dom.assetPreview.innerHTML = `<img src="${file.content}" class="asset-preview-image shadow-2xl">`;
            } else if (type === 'audio') {
                dom.assetPreview.innerHTML = `<div class="text-6xl mb-4">ðŸŽµ</div><audio controls src="${file.content}" class="w-64"></audio>`;
            } else if (type === 'model') {
                dom.assetPreview.innerHTML = `<div class="text-6xl mb-4 text-orange-500">ðŸ“¦</div><div class="text-lg font-bold">3D Model File</div><div class="text-xs text-zinc-500">${(file.content.length/1024).toFixed(1)} KB (Base64)</div>`;
            }
        }

        function updateHighlight() {
            const file = currentProject.files.find(f => f.name === activeFileName);
            if(!file || file.isBinary) return;

            const code = dom.editor.value;
            file.content = code;
            
            const ext = file.name.split('.').pop();
            const lang = ext === 'js' ? 'javascript' : (ext === 'html' ? 'markup' : 'css');
            dom.codeContent.className = `language-${lang}`;
            dom.codeContent.textContent = code;
            Prism.highlightElement(dom.codeContent);

            const lines = code.split('\n').length;
            dom.gutter.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
        }

        function syncScroll() {
            dom.highlighter.scrollTop = dom.editor.scrollTop;
            dom.highlighter.scrollLeft = dom.editor.scrollLeft;
            dom.gutter.scrollTop = dom.editor.scrollTop;
            
            if(dom.editor.scrollTop > 100) dom.scrollTopBtn.classList.add('visible');
            else dom.scrollTopBtn.classList.remove('visible');
        }
        
        function scrollToTop() {
            dom.editor.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- EXPORT LOGIC ---
        function exportProject() {
            const zip = new JSZip();
            
            currentProject.files.forEach(f => {
                if(f.type === 'folder') {
                    zip.folder(f.name); 
                    return;
                }
                
                if(f.isBinary) {
                    const parts = f.content.split(',');
                    const base64Data = parts[1];
                    zip.file(f.name, base64Data, {base64: true});
                } else {
                    zip.file(f.name, f.content);
                }
            });
            
            zip.generateAsync({type:"blob"}).then(function(content) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = currentProject.name.replace(/\s+/g, '_') + ".zip";
                a.click();
                
                dom.statusMsg.innerText = "Export Complete!";
                setTimeout(() => dom.statusMsg.innerText = "Ready", 3000);
            });
        }

        // --- COMPILER ENGINE ---
        async function runProject() {
            dom.console.innerHTML = '';
            logToConsole('System', 'Resolving modules & paths...');

            const urlMap = {};
            const files = currentProject.files.filter(f => f.type === 'file');

            files.forEach(f => {
                let blobUrl;
                if(f.isBinary) {
                    const byteString = atob(f.content.split(',')[1]);
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) { ia[i] = byteString.charCodeAt(i); }
                    const mime = f.content.split(';')[0].split(':')[1];
                    blobUrl = URL.createObjectURL(new Blob([ab], { type: mime }));
                } else {
                    const type = f.name.endsWith('.css') ? 'text/css' : (f.name.endsWith('.js') ? 'application/javascript' : 'text/html');
                    blobUrl = URL.createObjectURL(new Blob([f.content], { type }));
                }
                urlMap[f.name] = blobUrl;
            });

            const resolvedBlobs = {};
            files.forEach(f => {
                if(!f.isBinary && f.name.endsWith('.js') && f.strategy === 'module') {
                    let code = f.content.replace(/(import\s+.*?from\s+['"])(.*?)(['"])|(import\s+['"])(.*?)(['"])/g, (match, p1, p2, p3, p4, p5, p6) => {
                        const importPath = p2 || p5;
                        const prefix = p1 || p4;
                        const suffix = p3 || p6;
                        const absolutePath = resolvePath(f.name, importPath);
                        if(urlMap[absolutePath]) return `${prefix}${urlMap[absolutePath]}${suffix}`;
                        
                        logToConsole('error', `Import Error in ${f.name}: Cannot find "${importPath}" (resolved as "${absolutePath}")`);
                        return match; 
                    });
                    resolvedBlobs[f.name] = URL.createObjectURL(new Blob([code], { type: 'application/javascript' }));
                } else {
                    resolvedBlobs[f.name] = urlMap[f.name];
                }
            });

            const index = files.find(f => f.name === 'index.html') || files[0];
            let html = index.content;
            
            html = html.replace(/(src|href)=["'](.*?)["']/g, (match, attr, path) => {
                if(path.startsWith('http') || path.startsWith('//')) return match;
                const absolutePath = resolvePath('index.html', path); 
                if(urlMap[absolutePath]) return `${attr}="${urlMap[absolutePath]}"`;
                
                logToConsole('warn', `HTML Resource Warning: Cannot find "${path}" (resolved as "${absolutePath}")`);
                return match;
            });

            const consoleScript = `
                <script>
                    window.onerror = function(msg, url, line) {
                        window.parent.postMessage({type: 'error', msg: msg, line: line}, '*');
                    };
                    const oldLog = console.log;
                    console.log = function(...args) {
                        window.parent.postMessage({type: 'log', msg: args.join(' ')}, '*');
                        oldLog.apply(console, args);
                    };
                <\/script>
            `;

            let injections = consoleScript;
            files.forEach(f => {
                if(f.name === 'index.html' || f.isBinary) return;
                
                if(f.name.endsWith('.css')) {
                    let cssContent = f.content.replace(/url\(['"]?(.*?)['"]?\)/g, (match, path) => {
                        if(path.startsWith('http') || path.startsWith('data:')) return match;
                        const absolutePath = resolvePath(f.name, path);
                        if(urlMap[absolutePath]) return `url('${urlMap[absolutePath]}')`;
                        
                        logToConsole('warn', `CSS Resource Warning: Cannot find "${path}"`);
                        return match;
                    });
                    injections += `<style>${cssContent}</style>`;
                } else if(f.name.endsWith('.js')) {
                    const src = resolvedBlobs[f.name];
                    const isModule = f.strategy === 'module';
                    injections += `<script src="${src}" ${isModule ? 'type="module"' : ''}><\/script>`;
                }
            });

            if(html.includes('</body>')) {
                html = html.replace('</body>', injections + '</body>');
            } else {
                html += injections;
            }

            const finalBlob = new Blob([html], {type: 'text/html'});
            dom.previewFrame.src = URL.createObjectURL(finalBlob);
            dom.previewPanel.style.width = '45%';
            logToConsole('System', 'App Started.');
            
            saveData();
            setTimeout(captureThumbnail, 1500);
        }

        // --- FILE OPS ---
        function triggerRename(e, oldName) {
            e.stopPropagation();
            const newName = prompt("Enter new path/name:", oldName);
            if (!newName || newName === oldName) return;
            if (currentProject.files.some(f => f.name === newName)) return alert("Name already exists!");

            // Check if renaming folder
            const isFolder = currentProject.files.find(f => f.name === oldName)?.type === 'folder';

            if (isFolder) {
                currentProject.files.forEach(f => {
                    if (f.name === oldName) f.name = newName;
                    else if (f.name.startsWith(oldName + '/')) {
                        f.name = f.name.replace(oldName, newName);
                    }
                });
                if(expandedFolders.has(oldName)) {
                    expandedFolders.delete(oldName);
                    expandedFolders.add(newName);
                }
            } else {
                const target = currentProject.files.find(f => f.name === oldName);
                if(target) target.name = newName;
            }

            if (activeFileName === oldName) activeFileName = newName;
            else if (activeFileName.startsWith(oldName + '/')) activeFileName = activeFileName.replace(oldName, newName);

            saveData();
            renderFileList();
            loadEditor();
        }

        function addNewFile() {
            const path = prompt("Enter file path (e.g., src/components/button.js):", "new.js");
            if(path) {
                if(currentProject.files.some(f => f.name === path)) return alert("File exists!");
                currentProject.files.push({ 
                    name: path, 
                    type: 'file', 
                    content: '', 
                    isBinary: false, 
                    strategy: path.endsWith('.js') ? 'module' : 'classic' 
                });
                
                const parts = path.split('/');
                if(parts.length > 1) expandedFolders.add(parts.slice(0, -1).join('/'));

                saveData();
                renderFileList();
                activeFileName = path;
                loadEditor();
                updateProjectStats();
            }
        }

        function triggerNewFolder() {
            const path = prompt("Enter folder path (e.g., assets/models):");
            if(path) {
                if(!currentProject.files.some(f => f.name === path)) {
                    currentProject.files.push({ name: path, type: 'folder' });
                    expandedFolders.add(path);
                    saveData();
                    renderFileList();
                }
            }
        }

        function deleteFile(e, name) {
            e.stopPropagation();
            if(!confirm(`Delete ${name}?`)) return;
            currentProject.files = currentProject.files.filter(f => f.name !== name && !f.name.startsWith(name + '/'));
            if(activeFileName === name || activeFileName.startsWith(name + '/')) {
                activeFileName = currentProject.files.find(f => f.type === 'file')?.name || '';
            }
            saveData();
            renderFileList();
            loadEditor();
            updateProjectStats();
        }

        function deleteProject(e, id) {
            e.stopPropagation();
            if(!confirm("Delete project?")) return;
            projects = projects.filter(p => p.id !== id);
            saveData();
            renderProjectGrid();
        }

        function triggerUpload() { dom.fileInput.click(); }

        // --- UTILS ---
        function updateProjectName(name) {
            if(name.trim()) {
                currentProject.name = name;
                saveData();
            }
        }

        function saveData() {
            try {
                localStorage.setItem('nebula_ultra_projects', JSON.stringify(projects));
                updateProjectStats();
            } catch(e) { alert("Storage Full!"); }
        }

        function captureThumbnail() {
            try {
                if (dom.previewFrame.contentWindow.document.body) {
                    html2canvas(dom.previewFrame.contentWindow.document.body, { width: 600, height: 400, scale: 0.5 }).then(c => {
                        currentProject.thumbnail = c.toDataURL('image/jpeg', 0.5); 
                        saveData();
                    });
                }
            } catch (e) {}
        }
        
        function shareProject() {
            const json = JSON.stringify(currentProject);
            const compressed = LZString.compressToEncodedURIComponent(json);
            const url = window.location.origin + window.location.pathname + '?data=' + compressed;
            if(url.length > 8000) return alert("Project too big to link.");
            navigator.clipboard.writeText(url).then(() => alert("Link Copied!"));
        }

        function loadShared() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if(data) {
                try {
                    const p = JSON.parse(LZString.decompressFromEncodedURIComponent(data));
                    p.id = 'import-' + Date.now();
                    p.name += " (Shared)";
                    projects.unshift(p);
                    saveData();
                    openProject(p.id);
                    window.history.replaceState({},'',window.location.pathname);
                } catch(e) { console.error(e); }
            }
        }

        function logToConsole(type, msg) {
            const div = document.createElement('div');
            div.className = `log-entry ${type === 'error' ? 'log-error' : (type === 'warn' ? 'log-warn' : 'log-info')}`;
            div.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            dom.console.appendChild(div);
            dom.console.scrollTop = dom.console.scrollHeight;
        }

        function clearConsole() { dom.console.innerHTML = ''; }
        function togglePreview(ext) { if(ext && dom.previewFrame.src) window.open(dom.previewFrame.src, '_blank'); }
        function closePreview() { dom.previewPanel.style.width = '0%'; }

        // --- EVENTS ---
        dom.editor.addEventListener('input', updateHighlight);
        dom.editor.addEventListener('scroll', syncScroll);
        dom.editor.addEventListener('keydown', e => {
            if(e.key === 'Tab') { e.preventDefault(); dom.editor.setRangeText("  ", dom.editor.selectionStart, dom.editor.selectionEnd, "end"); updateHighlight(); }
            if((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); runProject(); }
        });

        dom.strategy.addEventListener('change', (e) => {
            const f = currentProject.files.find(x => x.name === activeFileName);
            if(f) { f.strategy = e.target.value; saveData(); }
        });

        dom.fileInput.addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                const isBinary = getFileType(file.name) !== 'text';
                reader.onload = (ev) => {
                    const path = file.webkitRelativePath || file.name;
                    if(!currentProject.files.some(f => f.name === path)) {
                        currentProject.files.push({
                            name: path,
                            type: 'file',
                            content: ev.target.result,
                            isBinary,
                            strategy: path.endsWith('.js') ? 'module' : 'classic'
                        });
                    }
                    saveData();
                    renderFileList();
                    updateProjectStats();
                };
                if(isBinary) reader.readAsDataURL(file); else reader.readAsText(file);
            });
            dom.fileInput.value = '';
        });

        window.addEventListener('message', e => {
            if(e.data.type === 'log') logToConsole('info', e.data.msg);
            if(e.data.type === 'error') logToConsole('error', e.data.msg);
        });

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            if(window.location.search.includes('data=')) loadShared();
            else renderProjectGrid();
        });
        
        let isResizing = false;
        dom.resizer.addEventListener('mousedown', () => isResizing = true);
        document.addEventListener('mousemove', e => {
            if(!isResizing) return;
            const w = document.body.clientWidth - e.clientX;
            const p = (w / document.body.clientWidth) * 100;
            if(p > 10 && p < 90) dom.previewPanel.style.width = p + '%';
        });
        document.addEventListener('mouseup', () => isResizing = false);
    </script>
</body>
</html>



