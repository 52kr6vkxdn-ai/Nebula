<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nebula Studio Ultra</title>
    
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.min.js"></script>

    <style>
        :root {
            /* Theme Variables - Default Indigo */
            --theme-main: #6366f1;
            --theme-hover: #4f46e5;
            --theme-text: #818cf8;
            --theme-shadow: rgba(99, 102, 241, 0.3);
            
            /* Static Variables */
            --bg-dark: #09090b;
            --panel-bg: #18181b;
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #a1a1aa;
        }

        /* Dynamic Theme Utility Classes */
        .bg-theme { background-color: var(--theme-main) !important; color: white !important; }
        .bg-theme-hover:hover { background-color: var(--theme-hover) !important; }
        .text-theme { color: var(--theme-main) !important; }
        .border-theme { border-color: var(--theme-main) !important; }
        .border-theme-focus:focus { border-color: var(--theme-main) !important; box-shadow: 0 0 0 1px var(--theme-main); }
        .shadow-theme { box-shadow: 0 10px 30px -10px var(--theme-shadow) !important; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .glass-panel { background: rgba(24, 24, 27, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }

        /* Project Cards */
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding: 2rem 0; }
        .project-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; position: relative; cursor: pointer; display: flex; flex-direction: column; }
        .project-card:hover { transform: translateY(-4px); border-color: var(--theme-main); box-shadow: 0 10px 30px -10px var(--theme-shadow); }
        
        .card-preview { height: 160px; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 1px solid var(--border); }
        .card-preview img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: opacity 0.3s; }
        .project-card:hover .card-preview img { opacity: 1; }

        /* Layout */
        #ide-container { display: flex; flex: 1; overflow: hidden; height: 100%; }
        .sidebar { width: 300px; background: #101012; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .editor-area { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #1e1e1e; position: relative; }
        .preview-area { width: 0%; background: #fff; display: flex; flex-direction: column; border-left: 1px solid var(--border); transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; }

        /* File Tree */
        .file-tree-item { display: flex; align-items: center; padding: 4px 8px; cursor: pointer; user-select: none; font-size: 13px; color: var(--text-dim); border-left: 2px solid transparent; transition: background 0.1s; }
        .file-tree-item:hover { background: #18181b; color: var(--text-main); }
        .file-tree-item.active { background: #18181b; color: #fff; border-left-color: var(--theme-main); }
        .file-tree-item.drag-over { background: rgba(255,255,255,0.05); border: 1px dashed var(--theme-main); }
        
        .tree-actions { display: none; margin-left: auto; gap: 4px; }
        .file-tree-item:hover .tree-actions { display: flex; }
        .action-btn { padding: 2px; border-radius: 3px; color: #71717a; }
        .action-btn:hover { color: #fff; background: #27272a; }
        .action-btn.delete:hover { color: #ef4444; }
        .action-btn.duplicate:hover { color: #10b981; }

        /* Editor Wrapper */
        .editor-wrapper { position: relative; flex: 1; overflow: hidden; display: flex; }
        #editor-container { flex: 1; height: 100%; }
        
        #asset-viewer { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; background: #121215; color: #71717a; padding: 2rem; text-align: center; }
        .asset-preview-image { max-width: 80%; max-height: 60%; object-fit: contain; border: 1px solid #3f3f46; background: url('data:image/svg+xml;utf8,<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><rect width="10" height="10" fill="%2318181b"/><rect x="10" y="10" width="10" height="10" fill="%2318181b"/><rect x="0" y="10" width="10" height="10" fill="%2327272a"/><rect x="10" y="0" width="10" height="10" fill="%2327272a"/></svg>'); }

        /* Console */
        .console-panel { height: 150px; background: #09090b; border-top: 1px solid var(--border); display: flex; flex-direction: column; }
        .console-logs { flex: 1; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 8px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-info { color: #a1a1aa; }
        .log-error { color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .log-warn { color: #facc15; }

        #resizer { width: 4px; background: transparent; cursor: col-resize; z-index: 50; margin-left: -2px; transition: background 0.2s; }
        #resizer:hover { background: var(--theme-main); }

        #project-name-input { background: transparent; border: 1px solid transparent; color: white; font-size: 1.125rem; font-weight: 600; padding: 4px 8px; border-radius: 4px; width: 200px; transition: all 0.2s; }
        #project-name-input:hover { border-color: #3f3f46; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #18181b; border: 1px solid var(--border); border-radius: 12px; width: 480px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        .loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--theme-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Drag and drop overlay */
        .root-dropzone { border: 2px dashed transparent; transition: border 0.2s; }
        .root-dropzone.drag-over { border-color: var(--theme-main); background: rgba(255,255,255,0.02); }
    </style>
</head>
<body>

    <!-- Global Loader -->
    <div id="loader" class="loader-overlay">
        <div class="spinner mb-4"></div>
        <div id="loader-msg" class="text-white font-mono text-sm tracking-widest uppercase">Processing...</div>
    </div>

    <!-- Header -->
    <header class="h-14 glass-panel flex items-center justify-between px-6 z-40 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="attemptHome()">
                <div class="w-8 h-8 rounded-lg bg-theme flex items-center justify-center text-white font-bold text-lg shadow-theme group-hover:scale-105 transition-transform">
                    N
                </div>
            </div>
            <div id="header-title-area" class="hidden flex items-center gap-2">
                <span class="text-zinc-600">/</span>
                <input type="text" id="project-name-input" value="Untitled Project" onchange="updateProjectName(this.value)">
                <span id="unsaved-badge" class="hidden text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded border border-red-500/30 font-bold ml-2">UNSAVED</span>
            </div>
            <div id="home-title-area" class="flex items-center gap-4">
                <span class="font-semibold text-lg tracking-tight">Nebula<span class="font-light text-theme">Studio</span></span>
            </div>
        </div>

        <div id="toolbar" class="hidden flex items-center gap-3">
            <button onclick="toggleModal('shortcuts-modal')" class="p-2 text-zinc-400 hover:text-white rounded-md hover:bg-zinc-800 transition-colors" title="Keyboard Shortcuts">
                <i data-lucide="keyboard" width="16" height="16"></i>
            </button>
            <div class="h-6 w-px bg-white/10 mx-1"></div>
            <button onclick="saveCurrentProject()" id="btn-save" class="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-3 py-1.5 rounded-md text-xs font-bold transition-colors border border-zinc-700" title="Save Project (Ctrl+S)">
                <i data-lucide="save" width="14" height="14"></i> SAVE
            </button>
            <button onclick="toggleModal('git-modal')" class="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-3 py-1.5 rounded-md text-xs font-bold transition-colors border border-zinc-700" title="GitHub Sync">
                <i data-lucide="github" width="14" height="14"></i> SYNC
            </button>
            <button onclick="toggleModal('deploy-modal')" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-md text-xs font-bold transition-colors shadow-lg shadow-emerald-900/20">
                <i data-lucide="rocket" width="14" height="14"></i> DEPLOY
            </button>
            <button onclick="exportProject()" class="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-3 py-1.5 rounded-md text-xs font-bold transition-colors border border-zinc-700">
                <i data-lucide="download" width="14" height="14"></i> EXPORT
            </button>
            <button onclick="runProject()" class="flex items-center gap-2 bg-theme bg-theme-hover text-white px-5 py-1.5 rounded-md text-xs font-bold transition-colors shadow-theme">
                <i data-lucide="play" width="14" height="14"></i> RUN
            </button>
            <button onclick="togglePreview(true)" class="p-2 text-zinc-400 hover:text-white rounded-md hover:bg-zinc-800 transition-colors" title="Full Screen">
                <i data-lucide="maximize" width="14" height="14"></i>
            </button>
        </div>
    </header>

    <!-- Home View -->
    <main id="view-home" class="flex-1 overflow-y-auto bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-zinc-800 via-zinc-950 to-black">
        <div class="max-w-7xl mx-auto p-8">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">Projects</h1>
                    <p class="text-zinc-400">Manage your experiments and applications.</p>
                </div>
                <div class="flex flex-col items-end gap-3">
                    <div class="flex gap-2 bg-zinc-900 border border-zinc-800 p-1.5 rounded-full">
                        <button onclick="setTheme('indigo')" class="w-5 h-5 rounded-full bg-[#6366f1] hover:scale-110 transition-transform cursor-pointer" title="Indigo"></button>
                        <button onclick="setTheme('emerald')" class="w-5 h-5 rounded-full bg-[#10b981] hover:scale-110 transition-transform cursor-pointer" title="Emerald"></button>
                        <button onclick="setTheme('rose')" class="w-5 h-5 rounded-full bg-[#f43f5e] hover:scale-110 transition-transform cursor-pointer" title="Rose"></button>
                        <button onclick="setTheme('sky')" class="w-5 h-5 rounded-full bg-[#0ea5e9] hover:scale-110 transition-transform cursor-pointer" title="Sky"></button>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="createNewProject()" class="bg-theme bg-theme-hover shadow-theme text-white px-6 py-2.5 rounded-full font-bold transition-all transform active:scale-95 flex items-center gap-2 text-sm">
                            <i data-lucide="plus" width="16" height="16"></i> New Project
                        </button>
                    </div>
                </div>
            </div>

            <div class="relative mb-8">
                <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-zinc-500" width="18" height="18"></i>
                <input type="text" id="project-search" placeholder="Search projects..." class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl pl-12 pr-4 py-3.5 text-white focus:border-theme-focus outline-none transition-all shadow-inner" oninput="renderProjectGrid()">
            </div>

            <div id="project-list" class="project-grid"></div>
        </div>
    </main>

    <!-- IDE View -->
    <main id="view-ide" class="hidden flex-1 relative min-h-0 flex flex-col">
        <div id="ide-container" class="flex-1 overflow-hidden flex">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="p-4 border-b border-[#27272a] flex justify-between items-center shrink-0">
                    <span class="text-xs font-bold text-zinc-500 uppercase tracking-wider">Explorer</span>
                    <div class="flex gap-1">
                         <button onclick="triggerNewFolder()" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white transition-colors" title="New Folder">
                            <i data-lucide="folder-plus" width="14" height="14"></i>
                        </button>
                        <button onclick="triggerUpload()" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white transition-colors" title="Upload Files (Max 5MB)">
                            <i data-lucide="upload" width="14" height="14"></i>
                        </button>
                        <button onclick="addNewFile()" class="p-1 hover:bg-zinc-800 rounded text-zinc-400 hover:text-white transition-colors" title="New File">
                            <i data-lucide="file-plus" width="14" height="14"></i>
                        </button>
                    </div>
                </div>
                <input type="file" id="fileInput" multiple accept="*/*" class="hidden">
                <!-- Root Dropzone -->
                <div id="file-list" class="flex-1 overflow-y-auto py-2 root-dropzone"></div>
                
                <div class="p-3 border-t border-[#27272a] bg-[#0c0c0e] text-[11px] text-zinc-500 flex flex-col gap-1">
                    <div class="flex justify-between items-center">
                        <span>Size:</span>
                        <span id="project-size-mb" class="font-mono text-zinc-300">0.00 MB</span>
                    </div>
                </div>
            </aside>

            <!-- Editor / Viewer -->
            <section class="editor-area">
                <div class="h-10 bg-[#141417] border-b border-[#27272a] flex items-center justify-between px-4 shrink-0">
                    <div class="flex items-center gap-2 text-xs">
                        <span class="text-zinc-500">Editing:</span>
                        <span id="active-filename" class="text-theme font-mono font-bold">index.html</span>
                    </div>
                    <select id="file-strategy" class="bg-[#18181b] border border-[#27272a] text-[10px] rounded px-2 py-1 text-zinc-400 outline-none border-theme-focus">
                        <option value="classic">Classic Script</option>
                        <option value="module">ES Module</option>
                    </select>
                </div>

                <div class="editor-wrapper">
                    <div id="editor-container"></div>
                    <div id="asset-viewer">
                        <div id="asset-preview-container" class="flex flex-col items-center gap-4"></div>
                        <p class="mt-6 text-sm text-zinc-500 max-w-xs">
                            <span class="font-bold text-zinc-400">Path:</span> 
                            <code id="asset-usage-code" class="bg-black px-1 py-0.5 rounded text-theme select-all"></code>
                        </p>
                    </div>
                </div>

                <!-- Console -->
                <div class="console-panel shrink-0">
                    <div class="h-8 bg-[#141417] border-b border-[#27272a] flex items-center justify-between px-4">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase">Terminal / Console</span>
                        <button onclick="clearConsole()" class="text-[10px] text-zinc-500 hover:text-white">CLEAR</button>
                    </div>
                    <div id="console-logs" class="console-logs"></div>
                </div>
            </section>

            <div id="resizer"></div>

            <!-- Preview -->
            <section id="preview-panel" class="preview-area">
                <div class="h-10 bg-zinc-100 border-b border-zinc-300 flex items-center justify-between px-4 shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs font-bold text-zinc-600">Live Server</span>
                    </div>
                    <button onclick="closePreview()" class="text-zinc-400 hover:text-red-500">
                        <i data-lucide="x" width="14" height="14"></i>
                    </button>
                </div>
                <div id="preview-wrapper" class="w-full h-full relative overflow-hidden">
                    <iframe id="preview-frame" class="w-full h-full border-none block" sandbox="allow-scripts allow-same-origin allow-modals"></iframe>
                </div>
            </section>
        </div>
        
        <div class="h-6 bg-[#09090b] border-t border-[#27272a] flex items-center px-3 font-mono text-[10px] text-[#52525b] gap-4">
            <span>Nebula Engine IDB</span>
            <span class="flex-1"></span>
            <span id="status-msg">Ready</span>
        </div>
    </main>

    <!-- Modals -->

    <!-- Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay">
        <div class="modal-content p-6 relative">
            <h2 class="text-lg font-bold text-white mb-4 border-b border-zinc-800 pb-2">⌨️ Keyboard Shortcuts</h2>
            <button onclick="toggleModal('shortcuts-modal')" class="absolute top-6 right-6 text-zinc-400 hover:text-white"><i data-lucide="x" width="18" height="18"></i></button>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between border-b border-zinc-800/50 pb-2"><span class="text-zinc-400">Save Project</span><span class="bg-zinc-800 text-white px-2 py-0.5 rounded font-mono text-xs">Ctrl + S</span></div>
                <div class="flex justify-between border-b border-zinc-800/50 pb-2"><span class="text-zinc-400">Run / Preview</span><span class="bg-zinc-800 text-white px-2 py-0.5 rounded font-mono text-xs">Ctrl + Enter</span></div>
                <div class="flex justify-between border-b border-zinc-800/50 pb-2"><span class="text-zinc-400">Command Palette (Editor)</span><span class="bg-zinc-800 text-white px-2 py-0.5 rounded font-mono text-xs">F1</span></div>
                <div class="flex justify-between"><span class="text-zinc-400">Close Modals</span><span class="bg-zinc-800 text-white px-2 py-0.5 rounded font-mono text-xs">Escape</span></div>
            </div>
            <p class="mt-6 text-xs text-zinc-500 text-center">Drag and drop files in the Explorer to organize them!</p>
        </div>
    </div>

    <!-- Deploy Modal -->
    <div id="deploy-modal" class="modal-overlay">
        <div class="modal-content p-0 relative overflow-hidden">
            <div class="p-6 border-b border-zinc-800 flex justify-between items-center bg-[#141417]">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="rocket" class="text-emerald-400"></i> Deploy Application</h2>
                <button onclick="toggleModal('deploy-modal')" class="text-zinc-400 hover:text-white"><i data-lucide="x" width="18" height="18"></i></button>
            </div>
            
            <div class="p-6 space-y-6 bg-[#0c0c0e]">
                <!-- GitHub Pages -->
                <div class="bg-[#18181b] border border-zinc-800 rounded-xl p-5 relative overflow-hidden group hover:border-emerald-500/50 transition-colors">
                    <div class="absolute -right-6 -top-6 text-zinc-800/20 group-hover:text-emerald-900/10 transition-colors"><i data-lucide="github" width="100" height="100"></i></div>
                    <h3 class="font-bold text-white text-md mb-1 relative">GitHub Pages</h3>
                    <p class="text-xs text-zinc-400 mb-4 relative max-w-[85%]">Pushes your code to a <code class="text-emerald-400">gh-pages</code> branch. If Pages is enabled on your repo, it will be live in minutes!</p>
                    <button onclick="deployToGHPages()" class="relative bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded text-sm font-bold transition-colors w-full">Deploy to GitHub Pages</button>
                    <p class="text-[10px] text-zinc-500 mt-2 text-center">Requires GitHub Sync to be configured first.</p>
                </div>

                <!-- Netlify Drop -->
                <div class="bg-[#18181b] border border-zinc-800 rounded-xl p-5 relative overflow-hidden group hover:border-cyan-500/50 transition-colors">
                    <div class="absolute -right-6 -top-6 text-zinc-800/20 group-hover:text-cyan-900/10 transition-colors"><i data-lucide="box" width="100" height="100"></i></div>
                    <h3 class="font-bold text-white text-md mb-1 relative">Netlify Drop</h3>
                    <p class="text-xs text-zinc-400 mb-4 relative max-w-[85%]">Export a production-ready ZIP file and drop it directly into Netlify to get a live URL instantly.</p>
                    <div class="flex gap-2 relative">
                        <button onclick="exportProject()" class="bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 rounded text-sm font-bold transition-colors flex-1 flex justify-center items-center gap-2"><i data-lucide="download" width="14" height="14"></i> 1. Export ZIP</button>
                        <a href="https://app.netlify.com/drop" target="_blank" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded text-sm font-bold transition-colors flex-1 text-center flex justify-center items-center gap-2">2. Open Netlify <i data-lucide="external-link" width="14" height="14"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Git Modal -->
    <div id="git-modal" class="modal-overlay">
        <div class="modal-content p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="github"></i> GitHub Sync</h2>
                <button onclick="toggleModal('git-modal')" class="text-zinc-400 hover:text-white"><i data-lucide="x" width="18" height="18"></i></button>
            </div>
            
            <div class="space-y-4 text-sm">
                <div>
                    <label class="block text-zinc-400 mb-1">Personal Access Token (PAT)</label>
                    <input type="password" id="git-pat" class="w-full bg-[#0c0c0e] border border-[#27272a] rounded px-3 py-2 text-white outline-none border-theme-focus">
                </div>
                <div>
                    <label class="block text-zinc-400 mb-1">Repository (e.g. username/repo)</label>
                    <input type="text" id="git-repo" class="w-full bg-[#0c0c0e] border border-[#27272a] rounded px-3 py-2 text-white outline-none border-theme-focus">
                </div>
                <div>
                    <label class="block text-zinc-400 mb-1">Branch</label>
                    <input type="text" id="git-branch" value="main" class="w-full bg-[#0c0c0e] border border-[#27272a] rounded px-3 py-2 text-white outline-none border-theme-focus">
                </div>
                
                <div class="flex gap-3 pt-4 border-t border-[#27272a]">
                    <button onclick="gitPull()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-2 rounded font-bold transition-colors">
                        Pull (Clone)
                    </button>
                </div>
                
                <div class="pt-4 border-t border-[#27272a]">
                    <label class="block text-zinc-400 mb-1">Commit Message</label>
                    <input type="text" id="git-msg" placeholder="Update from Nebula Studio" class="w-full bg-[#0c0c0e] border border-[#27272a] rounded px-3 py-2 text-white outline-none border-theme-focus mb-3">
                    <button onclick="gitPush()" class="w-full bg-theme bg-theme-hover text-white py-2 rounded font-bold transition-colors">
                        Commit & Push
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- THEMES ---
        const themes = {
            indigo: { main: '#6366f1', hover: '#4f46e5', text: '#818cf8', shadow: 'rgba(99,102,241,0.3)' },
            emerald: { main: '#10b981', hover: '#059669', text: '#34d399', shadow: 'rgba(16,185,129,0.3)' },
            rose: { main: '#f43f5e', hover: '#e11d48', text: '#fb7185', shadow: 'rgba(244,63,94,0.3)' },
            sky: { main: '#0ea5e9', hover: '#0284c7', text: '#38bdf8', shadow: 'rgba(14,165,233,0.3)' }
        };

        function setTheme(name) {
            const t = themes[name] || themes.indigo;
            const r = document.documentElement;
            r.style.setProperty('--theme-main', t.main);
            r.style.setProperty('--theme-hover', t.hover);
            r.style.setProperty('--theme-text', t.text);
            r.style.setProperty('--theme-shadow', t.shadow);
            localStorage.setItem('nebula_theme', name);
        }
        setTheme(localStorage.getItem('nebula_theme') || 'indigo');

        // --- INDEXED DB ENGINE ---
        const DB_NAME = "NebulaStudioIDB";
        const DB_VERSION = 1;
        const dbPromise = new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if(!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', {keyPath: 'id'});
            };
            req.onsuccess = (e) => resolve(e.target.result);
            req.onerror = (e) => reject(e.target.error);
        });

        async function dbGetAll() {
            const db = await dbPromise;
            return new Promise(res => {
                const tx = db.transaction('projects', 'readonly');
                const req = tx.objectStore('projects').getAll();
                req.onsuccess = () => res(req.result || []);
            });
        }

        async function dbGet(id) {
            const db = await dbPromise;
            return new Promise(res => {
                const tx = db.transaction('projects', 'readonly');
                const req = tx.objectStore('projects').get(id);
                req.onsuccess = () => res(req.result);
            });
        }

        async function dbPut(project) {
            const db = await dbPromise;
            return new Promise(res => {
                const tx = db.transaction('projects', 'readwrite');
                tx.objectStore('projects').put(project);
                tx.oncomplete = () => res();
            });
        }

        async function dbDelete(id) {
            const db = await dbPromise;
            return new Promise(res => {
                const tx = db.transaction('projects', 'readwrite');
                tx.objectStore('projects').delete(id);
                tx.oncomplete = () => res();
            });
        }

        // --- STATE & CONSTANTS ---
        const DEFAULT_PROJECT = {
            id: null, name: "Welcome Project", thumbnail: null, lastModified: Date.now(),
            files: [
                { name: "index.html", type: "file", isBinary: false, content: `<!DOCTYPE html>\n<html>\n<head>\n  <title>Nebula Welcome</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Welcome to Nebula Studio Ultra</h1>\n  <p>IndexedDB + Themes + Deployments</p>\n  <script src="script.js"><\/script>\n</body>\n</html>` },
                { name: "style.css", type: "file", isBinary: false, content: `body { background: #0f172a; color: white; font-family: sans-serif; text-align: center; padding-top: 50px; } h1 { color: var(--theme-text, #818cf8); }` },
                { name: "script.js", type: "file", isBinary: false, strategy: "classic", content: `console.log("System Online.");` }
            ]
        };

        let projectsMeta = []; // Lightweight for grid
        let currentProject = null;
        let activeFileName = "index.html"; 
        let expandedFolders = new Set(); 
        let monacoEditorInstance = null;
        let isSettingValue = false;
        let hasUnsavedChanges = false;

        const dom = {
            home: document.getElementById('view-home'), ide: document.getElementById('view-ide'),
            projectList: document.getElementById('project-list'), fileList: document.getElementById('file-list'),
            editorContainer: document.getElementById('editor-container'), assetViewer: document.getElementById('asset-viewer'),
            assetPreview: document.getElementById('asset-preview-container'), previewPanel: document.getElementById('preview-panel'),
            previewFrame: document.getElementById('preview-frame'), console: document.getElementById('console-logs'),
            filename: document.getElementById('active-filename'), strategy: document.getElementById('file-strategy'),
            toolbar: document.getElementById('toolbar'), projectNameInput: document.getElementById('project-name-input'),
            headerTitleArea: document.getElementById('header-title-area'), homeTitleArea: document.getElementById('home-title-area'),
            projectSizeMB: document.getElementById('project-size-mb'), statusMsg: document.getElementById('status-msg'),
            unsavedBadge: document.getElementById('unsaved-badge'), btnSave: document.getElementById('btn-save')
        };

        // --- GLOBAL UI HELPERS ---
        function setStatus(msg, timeout=0) {
            dom.statusMsg.innerText = msg;
            if(timeout > 0) setTimeout(() => dom.statusMsg.innerText = 'Ready', timeout);
        }

        function showLoader(msg) {
            document.getElementById('loader-msg').innerText = msg;
            document.getElementById('loader').style.display = 'flex';
        }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
        
        function toggleModal(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        function setDirty(state) {
            if(!currentProject) return;
            hasUnsavedChanges = state;
            dom.unsavedBadge.style.display = state ? 'inline-block' : 'none';
            dom.btnSave.classList.toggle('bg-theme', state);
            dom.btnSave.classList.toggle('text-white', state);
            dom.btnSave.classList.toggle('bg-zinc-800', !state);
        }

        // --- INIT & DATA ---
        async function bootSystem() {
            showLoader('Mounting IDB Volume...');
            
            // Migrate old localStorage
            const oldStorage = localStorage.getItem('nebula_ultra_projects');
            if (oldStorage) {
                try {
                    const parsed = JSON.parse(oldStorage);
                    for(let p of parsed) await dbPut(p);
                    localStorage.removeItem('nebula_ultra_projects');
                    console.log("Migrated legacy projects to IndexedDB.");
                } catch(e) { console.error("Migration failed", e); }
            }

            const all = await dbGetAll();
            if(all.length === 0) {
                const welcome = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
                welcome.id = 'proj-' + Date.now();
                await dbPut(welcome);
                all.push(welcome);
            }
            
            // Setup meta for grid
            projectsMeta = all.map(p => ({
                id: p.id, name: p.name, thumbnail: p.thumbnail, lastModified: p.lastModified, fileCount: p.files.length
            }));
            
            hideLoader();
            renderProjectGrid();
            lucide.createIcons();
        }

        // --- MONACO ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            monacoEditorInstance = monaco.editor.create(dom.editorContainer, {
                value: '', language: 'html', theme: 'vs-dark', automaticLayout: true, minimap: { enabled: true, scale: 0.75 },
                fontSize: 13, fontFamily: "'JetBrains Mono', monospace", roundedSelection: false, padding: { top: 16 }
            });

            monacoEditorInstance.onDidChangeModelContent(() => {
                if(isSettingValue || !currentProject) return;
                const file = currentProject.files.find(f => f.name === activeFileName);
                if(file) {
                    file.content = monacoEditorInstance.getValue();
                    setDirty(true);
                }
            });

            monacoEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => saveCurrentProject());
            monacoEditorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => runProject());
        });

        // --- NAVIGATION ---
        function attemptHome() {
            if(hasUnsavedChanges) {
                if(!confirm("You have unsaved changes. Discard and return to home?")) return;
            }
            showHome();
        }

        function showHome() {
            currentProject = null; setDirty(false);
            dom.ide.classList.add('hidden'); dom.home.classList.remove('hidden');
            dom.toolbar.classList.add('hidden'); dom.headerTitleArea.classList.add('hidden'); dom.homeTitleArea.classList.remove('hidden');
            bootSystem(); // Refresh grid
        }

        async function openProject(id) {
            showLoader('Loading Project Data...');
            currentProject = await dbGet(id);
            if(!currentProject) { hideLoader(); return alert("Project corrupted or missing."); }
            
            dom.home.classList.add('hidden'); dom.ide.classList.remove('hidden');
            dom.toolbar.classList.remove('hidden'); dom.homeTitleArea.classList.add('hidden'); dom.headerTitleArea.classList.remove('hidden');
            dom.projectNameInput.value = currentProject.name;
            setDirty(false);

            const index = currentProject.files.find(f => f.name === 'index.html');
            activeFileName = index ? index.name : currentProject.files.find(f=>f.type==='file')?.name;
            
            renderFileList();
            setTimeout(loadEditor, 100);
            updateProjectStats();
            lucide.createIcons();
            
            document.getElementById('git-pat').value = localStorage.getItem('nebula_git_pat') || '';
            document.getElementById('git-repo').value = currentProject.gitRepo || '';
            hideLoader();
        }

        async function createNewProject() {
            const name = prompt("Enter Project Name:", "My App");
            if (!name || name.trim() === "") return;
            const newP = JSON.parse(JSON.stringify(DEFAULT_PROJECT));
            newP.id = 'proj-' + Date.now(); newP.name = name;
            await dbPut(newP);
            openProject(newP.id);
        }

        async function duplicateProject(e, id) {
            e.stopPropagation();
            showLoader('Duplicating...');
            const p = await dbGet(id);
            const copy = JSON.parse(JSON.stringify(p));
            copy.id = 'proj-' + Date.now(); copy.name += ' (Copy)'; copy.lastModified = Date.now(); copy.thumbnail = null;
            await dbPut(copy);
            hideLoader(); bootSystem();
        }

        async function deleteProjectObj(e, id) {
            e.stopPropagation();
            if(!confirm("Permanently delete project?")) return;
            await dbDelete(id);
            bootSystem();
        }

        async function saveCurrentProject() {
            if(!currentProject) return;
            currentProject.lastModified = Date.now();
            await dbPut(currentProject);
            setDirty(false);
            setStatus("Saved successfully", 2000);
            updateProjectStats();
        }

        function updateProjectName(name) {
            if(name.trim()) { currentProject.name = name; setDirty(true); }
        }

        // --- RENDERERS ---
        function renderProjectGrid() {
            dom.projectList.innerHTML = '';
            const term = document.getElementById('project-search').value.toLowerCase();
            const filtered = projectsMeta.filter(p => p.name.toLowerCase().includes(term));
            
            if(filtered.length === 0) { dom.projectList.innerHTML = `<div class="col-span-full text-center text-zinc-500 py-12">No projects found.</div>`; return; }

            filtered.sort((a,b) => b.lastModified - a.lastModified).forEach(p => {
                const el = document.createElement('div');
                el.className = 'project-card group';
                const th = p.thumbnail ? `<img src="${p.thumbnail}">` : `<div class="text-6xl opacity-20 group-hover:opacity-40 text-theme font-mono transition-opacity">&lt;/&gt;</div>`;
                el.onclick = () => openProject(p.id);
                el.innerHTML = `
                    <div class="card-preview">${th}</div>
                    <div class="p-4 flex-1 flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-white group-hover:text-theme transition-colors truncate" title="${p.name}">${p.name}</h3>
                            <p class="text-xs text-zinc-500 mt-1">${p.fileCount} Items • ${new Date(p.lastModified).toLocaleDateString()}</p>
                        </div>
                        <div class="mt-4 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="duplicateProject(event, '${p.id}')" class="text-emerald-500 text-xs px-2 py-1 rounded hover:bg-emerald-500/10"><i data-lucide="copy" width="14" height="14"></i></button>
                            <button onclick="deleteProjectObj(event, '${p.id}')" class="text-red-500 text-xs px-2 py-1 rounded hover:bg-red-500/10"><i data-lucide="trash-2" width="14" height="14"></i></button>
                        </div>
                    </div>
                `;
                dom.projectList.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- DRAG & DROP FILE TREE ---
        function renderFileList() {
            dom.fileList.innerHTML = '';
            const tree = { name: "root", children: {}, files: [] };
            
            currentProject.files.forEach(file => {
                const parts = file.name.split('/');
                let current = tree;
                for(let i=0; i < parts.length - 1; i++) {
                    const part = parts[i];
                    if(!current.children[part]) current.children[part] = { name: part, path: parts.slice(0,i+1).join('/'), children: {}, files: [] };
                    current = current.children[part];
                }
                const fileName = parts[parts.length - 1];
                if(file.type === 'folder') {
                   if(!current.children[fileName]) current.children[fileName] = { name: fileName, path: file.name, children: {}, files: [] };
                } else current.files.push({ ...file, shortName: fileName });
            });

            function renderNode(node, depth = 0) {
                const container = document.createElement('div');
                const folders = Object.values(node.children).sort((a,b) => a.name.localeCompare(b.name));
                const files = node.files.sort((a,b) => a.shortName.localeCompare(b.shortName));

                folders.forEach(folder => {
                    const isExpanded = expandedFolders.has(folder.path);
                    const folderEl = document.createElement('div');
                    folderEl.className = 'file-tree-item group';
                    folderEl.style.paddingLeft = (depth * 12 + 8) + 'px';
                    folderEl.dataset.path = folder.path;
                    folderEl.dataset.type = 'folder';
                    folderEl.draggable = true;

                    // D&D Handlers
                    folderEl.ondragstart = (e) => { e.stopPropagation(); e.dataTransfer.setData('text/plain', folder.path); e.target.style.opacity = '0.5'; };
                    folderEl.ondragend = (e) => { e.target.style.opacity = '1'; };
                    folderEl.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); folderEl.classList.add('drag-over'); };
                    folderEl.ondragleave = (e) => { folderEl.classList.remove('drag-over'); };
                    folderEl.ondrop = (e) => { handleDrop(e, folder.path, true); folderEl.classList.remove('drag-over'); };

                    folderEl.innerHTML = `
                        <div class="flex items-center flex-1 overflow-hidden" onclick="toggleFolder(event, '${folder.path}')">
                            <i data-lucide="${isExpanded ? 'folder-open' : 'folder'}" width="14" height="14" class="mr-2 text-amber-400 shrink-0"></i>
                            <span class="truncate">${folder.name}</span>
                        </div>
                        <div class="tree-actions">
                             <button onclick="triggerRename(event, '${folder.path}')" class="action-btn"><i data-lucide="pencil" width="12" height="12"></i></button>
                             <button onclick="deleteNode(event, '${folder.path}', true)" class="action-btn delete"><i data-lucide="trash-2" width="12" height="12"></i></button>
                        </div>
                    `;
                    container.appendChild(folderEl);
                    if(isExpanded) container.appendChild(renderNode(folder, depth + 1));
                });

                files.forEach(file => {
                    let icon = 'file'; let color = 'text-zinc-500';
                    if(file.name.endsWith('.html')) { icon='file-code'; color='text-orange-500'; }
                    else if(file.name.endsWith('.css')) { icon='palette'; color='text-blue-400'; }
                    else if(file.name.endsWith('.js')) { icon='file-code-2'; color='text-yellow-400'; }
                    else if(file.isBinary) { icon='image'; color='text-pink-400'; }
                    
                    const fileEl = document.createElement('div');
                    fileEl.className = `file-tree-item ${file.name === activeFileName ? 'active' : ''} group`;
                    fileEl.style.paddingLeft = (depth * 12 + 8) + 'px';
                    fileEl.dataset.path = file.name;
                    fileEl.dataset.type = 'file';
                    fileEl.draggable = true;

                    // D&D Handlers
                    fileEl.ondragstart = (e) => { e.stopPropagation(); e.dataTransfer.setData('text/plain', file.name); e.target.style.opacity = '0.5'; };
                    fileEl.ondragend = (e) => { e.target.style.opacity = '1'; };
                    fileEl.ondragover = (e) => { e.preventDefault(); e.stopPropagation(); fileEl.classList.add('drag-over'); };
                    fileEl.ondragleave = (e) => { fileEl.classList.remove('drag-over'); };
                    fileEl.ondrop = (e) => { handleDrop(e, file.name, false); fileEl.classList.remove('drag-over'); };

                    fileEl.innerHTML = `
                        <div class="flex items-center flex-1 overflow-hidden" onclick="openFile('${file.name}')">
                            <i data-lucide="${icon}" width="14" height="14" class="mr-2 ${color} shrink-0"></i>
                            <span class="truncate">${file.shortName}</span>
                        </div>
                        <div class="tree-actions">
                            <button onclick="triggerRename(event, '${file.name}')" class="action-btn"><i data-lucide="pencil" width="12" height="12"></i></button>
                            <button onclick="deleteNode(event, '${file.name}', false)" class="action-btn delete"><i data-lucide="trash-2" width="12" height="12"></i></button>
                        </div>
                    `;
                    container.appendChild(fileEl);
                });
                return container;
            }
            dom.fileList.appendChild(renderNode(tree));
            lucide.createIcons();
        }

        // Root dropzone handlers
        dom.fileList.ondragover = (e) => { e.preventDefault(); dom.fileList.classList.add('drag-over'); };
        dom.fileList.ondragleave = (e) => { dom.fileList.classList.remove('drag-over'); };
        dom.fileList.ondrop = (e) => { handleDrop(e, '', true); dom.fileList.classList.remove('drag-over'); };

        function handleDrop(e, targetPath, isFolder) {
            e.preventDefault(); e.stopPropagation();
            const sourcePath = e.dataTransfer.getData('text/plain');
            if(!sourcePath || sourcePath === targetPath) return;

            // Prevent folder inception
            if (targetPath.startsWith(sourcePath + '/')) return alert("Cannot move a folder into itself.");

            let newDir = isFolder ? targetPath : targetPath.split('/').slice(0, -1).join('/');
            let sourceName = sourcePath.split('/').pop();
            let newPath = newDir ? `${newDir}/${sourceName}` : sourceName;

            if (sourcePath === newPath) return;
            if (currentProject.files.some(f => f.name === newPath)) return alert("Destination already exists!");

            const isSourceFolder = currentProject.files.find(f => f.name === sourcePath)?.type === 'folder';

            if(isSourceFolder) {
                currentProject.files.forEach(f => {
                    if(f.name === sourcePath) f.name = newPath;
                    else if(f.name.startsWith(sourcePath + '/')) f.name = f.name.replace(sourcePath + '/', newPath + '/');
                });
                expandedFolders.delete(sourcePath); expandedFolders.add(newPath);
            } else {
                const file = currentProject.files.find(f => f.name === sourcePath);
                if(file) file.name = newPath;
            }

            if(activeFileName === sourcePath) activeFileName = newPath;
            else if(activeFileName.startsWith(sourcePath + '/')) activeFileName = activeFileName.replace(sourcePath + '/', newPath + '/');

            if(newDir) expandedFolders.add(newDir);
            setDirty(true); renderFileList();
        }

        window.toggleFolder = (e, path) => {
            e.stopPropagation();
            if(expandedFolders.has(path)) expandedFolders.delete(path); else expandedFolders.add(path);
            renderFileList();
        };

        window.openFile = (name) => { activeFileName = name; renderFileList(); loadEditor(); };

        // --- FILE OPS ---
        function triggerRename(e, oldName) {
            e.stopPropagation();
            const newName = prompt("Enter new path/name:", oldName);
            if (!newName || newName === oldName) return;
            if (currentProject.files.some(f => f.name === newName)) return alert("Name exists!");

            const isFolder = currentProject.files.find(f => f.name === oldName)?.type === 'folder';

            if (isFolder) {
                currentProject.files.forEach(f => {
                    if (f.name === oldName) f.name = newName;
                    else if (f.name.startsWith(oldName + '/')) f.name = f.name.replace(oldName + '/', newName + '/');
                });
            } else {
                const target = currentProject.files.find(f => f.name === oldName);
                if(target) target.name = newName;
            }

            if (activeFileName === oldName) activeFileName = newName;
            else if (activeFileName.startsWith(oldName + '/')) activeFileName = activeFileName.replace(oldName + '/', newName + '/');

            setDirty(true); renderFileList(); loadEditor();
        }

        function addNewFile() {
            const path = prompt("Enter file path (e.g., src/utils.js):", "new.js");
            if(path && !currentProject.files.some(f => f.name === path)) {
                currentProject.files.push({ name: path, type: 'file', content: '', isBinary: false, strategy: path.endsWith('.js') ? 'module' : 'classic' });
                const parts = path.split('/'); if(parts.length > 1) expandedFolders.add(parts.slice(0, -1).join('/'));
                setDirty(true); activeFileName = path; renderFileList(); loadEditor(); updateProjectStats();
            }
        }

        function triggerNewFolder() {
            const path = prompt("Enter folder path:");
            if(path && !currentProject.files.some(f => f.name === path)) {
                currentProject.files.push({ name: path, type: 'folder' });
                expandedFolders.add(path); setDirty(true); renderFileList();
            }
        }

        function deleteNode(e, path, isFolder) {
            e.stopPropagation();
            if(!confirm(`Delete "${path}"?`)) return;
            if(isFolder) currentProject.files = currentProject.files.filter(f => f.name !== path && !f.name.startsWith(path + '/'));
            else currentProject.files = currentProject.files.filter(f => f.name !== path);

            if(activeFileName === path || activeFileName.startsWith(path + '/')) activeFileName = currentProject.files.find(f => f.type === 'file')?.name || '';
            setDirty(true); renderFileList(); loadEditor(); updateProjectStats();
        }

        function triggerUpload() { document.getElementById('fileInput').click(); }
        
        document.getElementById('fileInput').addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => {
                if(file.size > 5 * 1024 * 1024) return alert(`File ${file.name} exceeds 5MB limit.`);
                const reader = new FileReader();
                const isBinary = !['html','css','js','txt','json','md','xml'].includes(file.name.split('.').pop().toLowerCase());
                reader.onload = (ev) => {
                    const path = file.webkitRelativePath || file.name;
                    if(!currentProject.files.some(f => f.name === path)) {
                        currentProject.files.push({ name: path, type: 'file', content: ev.target.result, isBinary, strategy: path.endsWith('.js') ? 'module' : 'classic' });
                        setDirty(true); renderFileList(); updateProjectStats();
                    }
                };
                if(isBinary) reader.readAsDataURL(file); else reader.readAsText(file);
            });
            e.target.value = '';
        });

        // --- EDITOR & COMPILE ---
        function loadEditor() {
            if(!currentProject || !monacoEditorInstance) return;
            const file = currentProject.files.find(f => f.name === activeFileName);
            if(!file) return;

            dom.filename.innerText = file.name;
            if(file.isBinary) {
                dom.editorContainer.classList.add('hidden'); dom.assetViewer.style.display = 'flex'; dom.strategy.style.display = 'none';
                const t = file.name.split('.').pop().toLowerCase();
                if(['png','jpg','jpeg','gif','svg','webp'].includes(t)) dom.assetPreview.innerHTML = `<img src="${file.content}" class="asset-preview-image">`;
                else if(['mp3','wav'].includes(t)) dom.assetPreview.innerHTML = `<audio controls src="${file.content}"></audio>`;
                else dom.assetPreview.innerHTML = `<div class="text-6xl mb-4 text-theme">📦</div><div>Binary Asset</div>`;
                document.getElementById('asset-usage-code').innerText = `./${file.name}`;
            } else {
                dom.editorContainer.classList.remove('hidden'); dom.assetViewer.style.display = 'none';
                dom.strategy.style.display = file.name.endsWith('.js') ? 'block' : 'none'; dom.strategy.value = file.strategy || 'classic';
                
                isSettingValue = true;
                monacoEditorInstance.setValue(file.content || "");
                const ext = file.name.split('.').pop();
                monaco.editor.setModelLanguage(monacoEditorInstance.getModel(), { 'js':'javascript', 'html':'html', 'css':'css', 'json':'json', 'md':'markdown' }[ext] || 'plaintext');
                isSettingValue = false;
            }
        }

        async function runProject() {
            dom.console.innerHTML = '';
            logToConsole('System', 'Building and running...');
            await saveCurrentProject(); // Force save on run

            const urlMap = {};
            const files = currentProject.files.filter(f => f.type === 'file');

            // Generate Object URLs
            files.forEach(f => {
                if(f.isBinary) {
                    const byteString = atob(f.content.split(',')[1]);
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
                    urlMap[f.name] = URL.createObjectURL(new Blob([ab], { type: f.content.split(';')[0].split(':')[1] }));
                } else {
                    const type = f.name.endsWith('.css') ? 'text/css' : (f.name.endsWith('.js') ? 'application/javascript' : 'text/html');
                    urlMap[f.name] = URL.createObjectURL(new Blob([f.content + (f.name.endsWith('.js') ? `\n//# sourceURL=nebula://${f.name}` : '')], { type }));
                }
            });

            // Resolve Modules
            const resolvedBlobs = {};
            files.forEach(f => {
                if(!f.isBinary && f.name.endsWith('.js') && f.strategy === 'module') {
                    let code = f.content.replace(/(import\s+.*?from\s+['"])(.*?)(['"])|(import\s+['"])(.*?)(['"])/g, (match, p1, p2, p3, p4, p5, p6) => {
                        const path = p2 || p5;
                        const abs = resolvePath(f.name, path);
                        return urlMap[abs] ? `${p1 || p4}${urlMap[abs]}${p3 || p6}` : match; 
                    });
                    resolvedBlobs[f.name] = URL.createObjectURL(new Blob([code + `\n//# sourceURL=nebula://${f.name}`], { type: 'application/javascript' }));
                } else {
                    resolvedBlobs[f.name] = urlMap[f.name];
                }
            });

            const index = files.find(f => f.name === 'index.html') || files[0];
            if(!index) return;
            let html = index.content;
            
            // Resolve HTML src/href
            html = html.replace(/(src|href)=["'](.*?)["']/g, (match, attr, path) => {
                if(path.startsWith('http') || path.startsWith('//') || path.startsWith('data:')) return match;
                const abs = resolvePath('index.html', path); 
                return urlMap[abs] ? `${attr}="${urlMap[abs]}"` : match;
            });

            const consoleScript = `<script>window.onerror=function(m,u,l){let f=u||'';if(f.includes('nebula://'))f=f.split('nebula://')[1];window.parent.postMessage({type:'error',msg:m,file:f,line:l},'*');};const ol=console.log;console.log=function(...a){window.parent.postMessage({type:'log',msg:a.join(' ')},'*');ol.apply(console,a);};<\/script>`;
            
            let injections = consoleScript;
            files.forEach(f => {
                if(f.name === 'index.html' || f.isBinary) return;
                if(f.name.endsWith('.css')) injections += `<style>${f.content.replace(/url\(['"]?(.*?)['"]?\)/g, (m,p) => urlMap[resolvePath(f.name,p)] ? `url('${urlMap[resolvePath(f.name,p)]}')` : m)}</style>`;
                else if(f.name.endsWith('.js')) injections += `<script src="${resolvedBlobs[f.name]}" ${f.strategy==='module'?'type="module"':''}><\/script>`;
            });

            html = html.includes('</body>') ? html.replace('</body>', injections + '</body>') : html + injections;

            dom.previewFrame.src = URL.createObjectURL(new Blob([html], {type: 'text/html'}));
            dom.previewPanel.style.width = '45%';
            if(monacoEditorInstance) monacoEditorInstance.layout();
            
            setTimeout(() => {
                try {
                    html2canvas(dom.previewFrame.contentWindow.document.body, { width: 600, height: 400, scale: 0.5 }).then(c => {
                        currentProject.thumbnail = c.toDataURL('image/jpeg', 0.5); dbPut(currentProject);
                    });
                } catch (e) {}
            }, 1500);
        }

        // --- EXPORT & GIT DEPLOY ---
        function exportProject() {
            const zip = new JSZip();
            currentProject.files.forEach(f => {
                if(f.type === 'folder') zip.folder(f.name);
                else if(f.isBinary) zip.file(f.name, f.content.split(',')[1], {base64: true});
                else zip.file(f.name, f.content);
            });
            zip.generateAsync({type:"blob"}).then(c => {
                const a = document.createElement("a"); a.href = URL.createObjectURL(c);
                a.download = currentProject.name.replace(/\s+/g, '_') + ".zip"; a.click();
            });
        }

        async function gitApi(endpoint, method='GET', body=null) {
            const pat = document.getElementById('git-pat').value.trim();
            localStorage.setItem('nebula_git_pat', pat);
            const headers = { 'Accept': 'application/vnd.github.v3+json' };
            if(pat) headers['Authorization'] = `token ${pat}`;
            const res = await fetch(`https://api.github.com/repos/${document.getElementById('git-repo').value}/${endpoint}`, {method, headers, body: body?JSON.stringify(body):null});
            if(!res.ok) throw new Error(await res.text());
            return res.json();
        }

        async function gitPull() {
            try {
                showLoader('Cloning Repository...');
                currentProject.gitRepo = document.getElementById('git-repo').value;
                const branch = document.getElementById('git-branch').value || 'main';
                const treeRes = await gitApi(`git/trees/${branch}?recursive=1`);
                currentProject.files = []; 
                for(let item of treeRes.tree) {
                    if(item.type === 'tree') { currentProject.files.push({ name: item.path, type: 'folder' }); expandedFolders.add(item.path); }
                    else if(item.type === 'blob') {
                        const blobRes = await gitApi(`git/blobs/${item.sha}`);
                        const isText = !item.path.match(/\.(png|jpg|jpeg|gif|ico|mp3|wav|glb)$/i);
                        let content = blobRes.encoding === 'base64' ? (isText ? decodeURIComponent(escape(window.atob(blobRes.content))) : `data:application/octet-stream;base64,${blobRes.content.replace(/\n/g, '')}`) : blobRes.content;
                        currentProject.files.push({ name: item.path, type: 'file', content: content, isBinary: !isText, strategy: item.path.endsWith('.js') ? 'module' : 'classic' });
                    }
                }
                setDirty(true); await saveCurrentProject(); renderFileList(); loadEditor(); toggleModal('git-modal'); hideLoader();
            } catch(e) { hideLoader(); alert("Pull Failed: " + e.message); }
        }

        async function pushToBranch(branch, msg) {
            showLoader(`Pushing to ${branch}...`);
            const ref = await gitApi(`git/refs/heads/${branch}`).catch(async () => {
                // Create branch if not exists based on main/master
                const mRef = await gitApi('git/refs/heads/main').catch(()=>gitApi('git/refs/heads/master'));
                return gitApi('git/refs', 'POST', { ref: `refs/heads/${branch}`, sha: mRef.object.sha });
            });
            const baseTreeSha = (await gitApi(`git/commits/${ref.object.sha}`)).tree.sha;
            
            const newTree = [];
            for(let f of currentProject.files) {
                if(f.type === 'folder') continue;
                const content = f.isBinary ? f.content.split(',')[1] : f.content;
                const blob = await gitApi('git/blobs', 'POST', { content, encoding: f.isBinary?'base64':'utf-8' });
                newTree.push({ path: f.name, mode: '100644', type: 'blob', sha: blob.sha });
            }
            
            const tree = await gitApi('git/trees', 'POST', { base_tree: baseTreeSha, tree: newTree });
            const newCommit = await gitApi('git/commits', 'POST', { message: msg, tree: tree.sha, parents: [ref.object.sha] });
            await gitApi(`git/refs/heads/${branch}`, 'PATCH', { sha: newCommit.sha });
            hideLoader();
        }

        async function gitPush() {
            try { await pushToBranch(document.getElementById('git-branch').value || 'main', document.getElementById('git-msg').value || 'Update via Nebula'); toggleModal('git-modal'); document.getElementById('git-msg').value = ''; setStatus("Push Successful!", 4000); }
            catch(e) { hideLoader(); alert("Push Failed: " + e.message); }
        }

        async function deployToGHPages() {
            try {
                if(!document.getElementById('git-repo').value || !document.getElementById('git-pat').value) {
                    toggleModal('deploy-modal'); toggleModal('git-modal');
                    return alert("Please configure GitHub Sync details first.");
                }
                await pushToBranch('gh-pages', '🚀 Deploy from Nebula Studio');
                toggleModal('deploy-modal'); alert("Deployed to gh-pages branch! If Pages is enabled on GitHub, it will be live shortly.");
            } catch(e) { hideLoader(); alert("Deploy Failed: " + e.message); }
        }

        // --- UTILS ---
        function resolvePath(b, r) { const s = b.includes('/') ? b.split('/').slice(0, -1) : []; for (let p of r.split('/')) { if (p==='.'||p==='') continue; if (p==='..') s.pop(); else s.push(p); } return s.join('/'); }
        function updateProjectStats() { dom.projectSizeMB.innerText = currentProject ? `${(new Blob([JSON.stringify(currentProject)]).size / 1024 / 1024).toFixed(2)} MB` : '0.00 MB'; }
        function logToConsole(type, msg, file='', line='') { const d = document.createElement('div'); d.className = `log-entry ${type==='error'?'log-error':(type==='warn'?'log-warn':'log-info')}`; d.innerHTML = `${file?`<span class="text-[10px] float-right text-zinc-500">${file}${line?`:${line}`:''}</span>`:''}<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${msg}`; dom.console.appendChild(d); dom.console.scrollTop = dom.console.scrollHeight; }
        function clearConsole() { dom.console.innerHTML = ''; }
        function togglePreview(ext) { if(ext && dom.previewFrame.src) window.open(dom.previewFrame.src, '_blank'); }
        function closePreview() { dom.previewPanel.style.width = '0%'; if(monacoEditorInstance) monacoEditorInstance.layout(); }

        // --- EVENTS ---
        window.addEventListener('message', e => { if(e.data.type==='log') logToConsole('info', e.data.msg); if(e.data.type==='error') logToConsole('error', e.data.msg, e.data.file, e.data.line); });
        dom.strategy.addEventListener('change', e => { const f=currentProject.files.find(x=>x.name===activeFileName); if(f) {f.strategy=e.target.value; setDirty(true);} });
        
        let isResizing = false;
        dom.resizer.addEventListener('mousedown', () => isResizing = true);
        document.addEventListener('mousemove', e => { if(isResizing) { const p = ((document.body.clientWidth - e.clientX) / document.body.clientWidth) * 100; if(p > 10 && p < 90) { dom.previewPanel.style.width = p + '%'; if(monacoEditorInstance) monacoEditorInstance.layout(); } } });
        document.addEventListener('mouseup', () => isResizing = false);
        window.addEventListener('resize', () => { if(monacoEditorInstance) monacoEditorInstance.layout(); });
        window.addEventListener('beforeunload', e => { if(hasUnsavedChanges) e.returnValue = 'Unsaved changes!'; });
        document.addEventListener('keydown', e => { if(e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); });

        window.addEventListener('DOMContentLoaded', bootSystem);
    </script>
</body>
</html>




